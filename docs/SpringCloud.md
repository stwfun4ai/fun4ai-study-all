# 				Spring Cloud升级

------

<img src="images/spring cloud升级.png" alt="images/" style="zoom:200%;" />

- 服务注册与发现中心
  - ~~Eureka~~	（AP）
  - **ZooKeeper**（CP）
  - **Consul**（CP）
  - **Nacos** （AP/CP）
- 服务调用
  - **Ribbon** 客户端框架
  - **LoadBalancer**
- 服务调用2
  - ~~Feign~~
  - **OpenFeign**
- 服务降级
  - ~~Hystrix~~
  - **resilience4j**
  - **sentinel**
- 服务网关
  - ~~Zuul~~
  - ~~Zuul2~~
  - **gateway**
- 服务配置
  - ~~Config~~
  - **Nacos**
- 服务总线
  - ~~Bus~~
  - **Nacos**
- 链路追踪
  - **slueth zipkin** 

# Spring Cloud Alibaba

## Nacos

### 主流的服务注册中心产品？（美团）

|                 | **Nacos**                  | **Eureka**  | **Consul**        | **CoreDNS** | **Zookeeper** |
| --------------- | -------------------------- | ----------- | ----------------- | ----------- | ------------- |
| 一致性协议      | CP+AP                      | AP          | CP                | —           | CP            |
| 健康检查        | TCP/HTTP/MYSQL/Client Beat | Client Beat | TCP/HTTP/gRPC/Cmd | —           | Keep Alive    |
| 负载均衡策略    | 权重/ metadata/Selector    | Ribbon      | Fabio             | RoundRobin  | —             |
| 雪崩保护        | 有                         | 有          | 无                | 无          | 无            |
| 自动注销实例    | 支持                       | 支持        | 不支持            | 不支持      | 支持          |
| 访问协议        | HTTP/DNS                   | HTTP        | HTTP/DNS          | DNS         | TCP           |
| 监听支持        | 支持                       | 支持        | 支持              | 不支持      | 支持          |
| 多数据中心      | 支持                       | 支持        | 支持              | 不支持      | 不支持        |
| 跨注册中心同步  | 支持                       | 不支持      | 支持              | 不支持      | 不支持        |
| SpringCloud集成 | 支持                       | 支持        | 支持              | 不支持      | 支持          |
| Dubbo集成       | 支持                       | 不支持      | 不支持            | 不支持      | 支持          |
| K8S集成         | 支持                       | 不支持      | 支持              | 支持        | 不支持        |

### nacos工作原理？（华为）（滴滴）

1. **服务注册原理：在`nacos`的服务端，有一个用来管理微服务实例的容器**，注册中心将微服务的实例交由`ServiceHolder`处理，`ServiceHolder`为微服务提供空间并将它的所有实例挂在该空间下。服务注册完成后提供者将于注册中心维护心跳机制，心跳机制可以保证注册中心可以及时的剔除失效的实例。
2. **服务发现原理：**服务完成注册之后，消费者可以向注册中心订阅某个服务，并提交一个监视器，当注册中心的服务发生变更时监听器会收到通知，然后消费者可以更新本地的服务实例列表，以保证所有的服务均可用。
3. **nacos的负载均衡：**`Nacos` 的客户端在获取到服务的完整实例列表后，会在客户端进行负载均衡算法来获取一个可用的实例，模式使用的是随机获取的方式。

### dubbo的注册中心原理？（百度）

0、服务容器负责启动，加载，运行服务提供者。 

1、服务提供者在启动时，向注册中心注册自己提供的服务。 

2、服务消费者在启动时，向注册中心订阅自己所需的服务。 

3、注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。 4、服务消费者，从提供者地址列表中，**基于软负载均衡算法**，选一台提供者进行调用，如果调用失败，再选另一台调用。

5、服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。

## seata

`Seata`提供**一站式的分布式事务解决方案**。可以提供**AT**（默认使用，基于2PC两阶段模式）、 TCC、 SAGA 、XA事务模式。

`Seata`的3 + 1个概念：

- **TC：事务协调器**，负责维护分布式事务的运行状态。负责协调并驱动全局事务的提交或者回滚。
- **TM： 事务管理器**，是一个分布式的发起者和终结者。最终发起全局提交或回滚决议。
- **RM：资源管理器**，负责本地事务的运行。负责分支注册，状态汇报，接收事务协调器的指令，驱动本地事务的提交和回滚。
- **Transaction ID**：全局事务的唯一ID ， XID。

TM是一个分布式事务的发起者和终结者，TC负责维护分布式事务的运行状态，而RM则负责本地事务的运行。

### 工作流程

1. TM向TC申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID
2. XID在微服务的调用链路中传播
3. RM向TC注册分支事务，将其纳入XID对应的全局事务管辖
4. TM向TC发起针对XID的全局提交或者回滚决议
5. TC调度XID下管辖的全部分支事务完成提交或者回滚请求

### 使用

1. 对于每个微服务对应的数据库都需要添加一张回滚日志表。用于自动的回滚一些数据。
2. 下载`seata-server`软件包，`github.com/seata/seata/releases`
3. 导入依赖 `spring-cloud-starter-alibaba-seata`
4. 启动 `seata-server`
5. 所有想要使用到分布式事务的微服务使用`seata DatasourceProxy`代理自己的数据源
6. `@GlobaTransactional` 开启全局事务。（只需要给分布式事务入口标上该注解即可），对于远程调用的方法不需要标。
7. 启动各个微服务即可。



## sentinel 

随着**微服务**的流行，**服务和服务之间的稳定性变得越来越重要**。Sentinel 是面向**分布式服务**架构的**轻量级高可用流量控制**产品，由阿里中间件团队开源。主要以流量为切入点，从**流量限制、服务熔断降级、**系统负载保护等多个维度来帮助您保护服务的稳定性。

sentinel项目分为7个主要部分，其中最主要的 就是sentinel-core模块。限流、熔断、降级、系统保护等都在这里实现。

> 由于Netflix的`hystrix`停止更新，所以改用spring cloud Alibaba的sentinel组件实现系统的**限流、熔断、降级。**

| 对比内容       | Sentinel                                       | Hystrix                       |
| -------------- | ---------------------------------------------- | ----------------------------- |
| 隔离策略       | 信号量隔离                                     | 线程池隔离/信号量隔离         |
| 熔断降级策略   | 基于响应时间或失败比率                         | 基于失败比率                  |
| 实时指标实现   | 滑动窗口                                       | 滑动窗口（基于 RxJava）       |
| 规则配置       | 支持多种数据源                                 | 支持多种数据源                |
| 扩展性         | 多个扩展点                                     | 插件的形式                    |
| 基于注解的支持 | 支持                                           | 支持                          |
| 限流           | 基于 QPS，支持基于调用关系的限流               | 不支持                        |
| 流量整形       | 支持慢启动、匀速器模式                         | 不支持                        |
| 系统负载保护   | 支持                                           | 不支持                        |
| 控制台         | 开箱即用，可配置规则、查看秒级监控、机器发现等 | 不完善                        |
| 常见框架的适配 | Servlet、Spring Cloud、Dubbo、gRPC 等          | Servlet、Spring Cloud Netflix |

### 流量控制

流量控制在网络传输中是一个常用的概念，**它用于调整网络包的发送数据**。然而，从系统稳定性角度考虑，在处理请求的速度上，也有非常多的讲究。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状。

## 限流、熔断、降级

**限流：**对于打入集群的请求流量在入口处进行控制，使服务能够承担不超过自己能力的流量压 力。

**熔断：**A服务调用B服务，由于各种各样的原因导致请求时间过长。这样的情况次数过多就应该考虑将B服务直接断路。凡是调用B服务直接返回错误数据。

**降级：**由于服务器的压力较大而对一些服务进行有针对的降级，从而保证核心业务的正常运行。



# OpenFeign

## 使用

1. 首先，调用以及被调用的微服务双方都应该被**注册到注册中心**。
2. Spring Boot启动APP上标注 `@EnableFeignClients`注解。
3. 编写远程调用接口并标注`@FeignClient`注解。（括号内添加所要调用的微服务名称）
4. 接口中的方法为实际想要调用的服务的方法签名，并使用`@PostMapping`注解映射为一个post类型的HTTP请求。

## 实现远程调用原理

核心原理就是**通过一系列的封装和处理**，将以Java注解的方式定义的远程调用API接口，最终转化为HTTP的请求与响应结果。

从下图可以看到，Feign通过**处理注解**，**将请求模板化**，当实际调用的时候，传入参数，根据参数再应用到请求上，进而转化成真正的 Request 请求。

1. 微服务启动时，feign对添加了`@FeignClient`的接口扫描，创建远程接口的本地JDK Proxy代理实例。然后注入到Spring IOC容器中。**当远程接口的方法被调用，由Proxy代理实例去完成真正的远程访问，并且返回结果。**
2. Feign的方法处理器 `MethodHandler` 。它用来解析方法上的`url`，以及`@postMapping`注解中包含的数据，并生成一个http请求模板。
3. 在 `MethodHandler` 中具体由`requestTemplate`发起request请求。Request 经过编码交给`httpclient`发送到远程调用服务。

![img](images/feigen远程调用原理图.png)

## 解决远程调用的负载均衡问题

feign内部有Ribbon实现了客户端的负载均衡。从注册中心读取所有可用的服务提供者，在客户端每次调用接口时采用如轮询负载均衡算法选出一个服务提供者调用，因此，`Ribbon`是一个客户端负载均衡器。

常见的负载均衡策略有：

1. 轮询：可能会导致性能较弱的服务器过载
2. 加权轮询：可以为每台服务器分配权重，能力较弱的服务器分配较少的连接请求
3. 最少连接数：
4. 加权最少连接：

# Gateway

## 定义

挡在众多微服务前面的一堵墙，用来**管理、授权、流量限制**等等。可以保护后台的微服务。Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是**替代ZUUL**，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。

## 作用

1. 作为所有微服务的请求入口。
2. 对所有的API进行统一的管理、分发。
3. 作为所有后端服务的聚合点。

## 几个重要的概念说一说？（美团）

1. Route（路由）：是网关的基本构建模块，由一个ID、一个目标URI、一组断言、一组过滤器实现。如果断言为真，则会路由至指定的服务中。
2. Predicate （断言）：即一种**匹配规则**。可以根据多种情况进行匹配。我最常用的是根据path或Host进行匹配。
3. Filter（过滤器）：负责对过来的请求按照某种规则进行修改

```yml
gateway:
# 路由的示例
  routes:
    - id: product_route
      uri: lb://mall-product
      predicates:
        # 根据path进行匹配
        - Path=/api/product/**
        # 根据host进行匹配，可以一次匹配多个host。
        - Host=catmall.com, item.catmall.com
      filters:
        - RewritePath=/api/(?<segment>.*),/$\{segment}
```
